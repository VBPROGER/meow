#!/bin/bash

function pass(){
	:
}
function meowecho(){
	echo "meow: ${1}"
}
function meowpass(){
	pass
}
function meowautoclear(){
	clear || meowpass
}
function _pullme(){
	type="$1"
	if [[ "$type" == "linux" ]]; then
		curl https://raw.githubusercontent.com/VBPROGER/meow/main/src/meow>~/.local/bin/meow 2>/dev/null;
		chmod u+x ~/.local/bin/meow
	elif [[ "$type" == "darwin" ]]; then
		# Note: On darwin, you need to install cUrl by yourself, because it's not installed by default
		curl https://raw.githubusercontent.com/VBPROGER/meow/main/src/meow>~/meow 2>/dev/null;
		chmod u+x ~/meow
	else
		meowecho 'Something went wrong, failed to determine OS type'
	fi
}

acedf="$1"
arg2="$2"
arg3="$3"
version="1.0.0"
MEOWPATH=~/.meow
ac="meow "

mkdir -p $MEOWPATH 2>/dev/null

if [[ "$acedf" == "" ]]; then
	while true; do
		read -p "" "meow"
		echo $meow
	done
elif [[ "$acedf" == "mew" ]]; then
	meowecho "processing..."
	to_download=$arg2
	meowecho "downloading..."
	mkdir -p "$MEOWPATH/${to_download}" 2>/dev/null
	meowecho "downloading \"main\" file..."
	/usr/bin/env curl "https://raw.githubusercontent.com/VBPROGER/meow/main/pkg/$to_download/main" > "${MEOWPATH}/${to_download}/main" 2>/dev/null
	/usr/bin/chmod +x "${MEOWPATH}/${to_download}"/main 2>/dev/null
	meowecho "downloading \"todownload\" file..."
	/usr/bin/env curl "https://raw.githubusercontent.com/VBPROGER/meow/main/pkg/$to_download/todownload" > "${MEOWPATH}/${to_download}"/todownload 2>/dev/null
	/usr/bin/chmod +x ${MEOWPATH}/${to_download}/todownload 2>/dev/null
	meowecho "checking required file(s)/folder(s) file..."
	for line in `cat ${MEOWPATH}/${to_download}/todownload`; do
		meowecho "downloading \"$line\" file by request..."
		/usr/bin/env curl "https://raw.githubusercontent.com/VBPROGER/meow/main/pkg/$to_download/$line" > "${MEOWPATH}/${to_download}/$line" 2>/dev/null
		/usr/bin/chmod +x "${MEOWPATH}/${to_download}/$line" 2>/dev/null
	done
elif [[ "$acedf" == "help" ]]; then
	meowecho "--- meow v${version} ---
welcome!

-..- CMD HELP -..-

${ac}help [*anyarguments]
	shows list of commands,
	info and more.
${ac}mew <name> [*anyarguments]
	download/install package by
	name using the \"mew\" method.
	downloading/installing folders
	is not allowed, if is even mentioned
	in the \"todownload\" file.
	if \"force\" argument is not
	equals \"null\" then meow
	will ignore ~~all~~ folder errors.
${ac}run <name> [*anyarguments]
	make the package executable
	and launch it, if possible.
	if package with name <name>
	does not exist, it will show
	error. there's no way yet
	to hide this error.
${ac}del <name> [-s] || [--silent] [*anyarguments]
	will attempt to delete package
	with name <name>, if not installed,
	will show error (if -s || --silent
	argument is not used).
${ac}ulist [-s] || [--strip] [*anyarguments]
	get list of aviable packages.
	if -s is used, then it will
	not create newline at the end
${ac}clean <-f> || <--force> [*anyarguments]
	delete all installed packages
	from the current machine.
${ac}pullme [*anyarguments]
       update self to the newest
	version of MEOW package manager.

-..- EXAMPLES FOR CMD -..-

${ac}mew mycoolpackage
# will download package with name 'mycoolpackage'.
${ac}ulist --strip
# will show all packages (no newline at the end)
${ac}del firstpkg
# will delete package with the name \"firstpkg\"
${ac}clean -f
# clean all packages (wipe)
${ac}pullme
# update self
"
elif [[ "$acedf" == "ulist" ]]; then
	for filename in "${MEOWPATH?:}"/*; do
			printf "%s\n" "${filename}"
		done
		if [[ ("$arg2" != "-s") && ("$arg2" != "--strip") ]]; then
			echo ''
		fi
elif [[ "$acedf" == "del" ]]; then
	if [[ "${arg2}" != '' ]] && [ -d "${MEOWPATH:?}/${arg2}" ]; then
		rm -rf "${MEOWPATH:?}/${arg2}" 2>/dev/null
		if [[ ! ("$arg3" == '-s' || "$arg3" == '--silent') ]]; then
			meowecho "successfully removed pkg with name '${arg2}'"
		fi
	else
		if [[ ! ("$arg3" == '-s' || "$arg3" == '--silent') ]]; then
			meowecho "failed to remove pkg with name '${arg2}'"
		fi
	fi
elif [[ "$acedf" == "clean" ]]; then
	if [[ "$arg2" == '-f' || "$arg2" == '--force' ]]; then
		for filename in "${MEOWPATH}"/*; do
			rm -rf "$filename"
		done
	fi
elif [[ "$acedf" == "pullme" ]]; then
	meowecho 'Pulling the newest MEOW version...'
	if [[ "$arg2" == '' ]]; then
		if [[ "$OSTYPE" == "linux-gnu"* ]]; then
				_pullme linux
		elif [[ "$OSTYPE" == "darwin"* ]]; then
				_pullme darwin
		elif [[ "$OSTYPE" == "cygwin" ]]; then
				_pullme linux
		elif [[ "$OSTYPE" == "msys" ]]; then
				_pullme linux
		elif [[ "$OSTYPE" == "win32" ]]; then
				meowecho "Windows is not supported"
		elif [[ "$OSTYPE" == "freebsd"* ]]; then
				_pullme linux
		else
				meowecho 'Unsupported OS type: '"\"${OSTYPE}\""
		fi
	else
		_pullme "$arg2"
	fi
	meowecho 'Done!'
else
	meowecho "welcome to meow, v${version}."
fi